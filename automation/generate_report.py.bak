from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.units import mm
from reportlab.pdfgen import canvas
#!/usr/bin/env python3

from datetime import date, datetime
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import mm
from reportlab.lib import colors
from reportlab.lib.styles import getSampleStyleSheet
from reportlab.pdfgen import canvas
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle

# -*- coding: utf-8 -*-

"""
Generate Finance Report (Pro++)
- Reads from MongoDB (safe query)
- Matplotlib chart -> PNG
- ReportLab PDF with summary
"""

import os
from pathlib import Path

from dotenv import load_dotenv
from pymongo import MongoClient, errors
import matplotlib.pyplot as plt

    Image,
)

GOAL_AMOUNT = int(os.getenv("GOAL_AMOUNT", "300000"))
GOAL_DATE = os.getenv("GOAL_DATE", "2025-09-26")  # YYYY-MM-DD

ROOT = Path(__file__).resolve().parent
load_dotenv(ROOT / ".env")

MONGO_URI = os.getenv("MONGO_URI", "mongodb://localhost:27017")
MONGO_DB = os.getenv("MONGO_DB", "proplus")
MONGO_COL = os.getenv("MONGO_COLLECTION", "finance")

REPORTS_DIR = Path(os.getenv("REPORTS_DIR", ROOT.parent / "data_analytics" / "reports"))
REPORTS_DIR.mkdir(parents=True, exist_ok=True)

# ---------- DB ----------
def get_collection():
    client = MongoClient(MONGO_URI, serverSelectionTimeoutMS=5000)
    client.admin.command("ping")
    return client[MONGO_DB][MONGO_COL]

def fetch_data():
    col = get_collection()
    query = {
        "income": {"$exists": True},
        "debt": {"$exists": True},
        "savings": {"$exists": True},
    }
    return list(col.find(query).sort("ts", 1))

# ---------- Chart ----------
def create_chart(data, chart_path: Path):
    if not data:
        raise RuntimeError("No data to chart")

    x = [d.get("ts") for d in data]
    income = [d.get("income", 0) for d in data]
    debt = [d.get("debt", 0) for d in data]
    savings = [d.get("savings", 0) for d in data]

    plt.figure(figsize=(8, 5))
    plt.plot(x, income, marker="o", label="ÔµÕ¯Õ¡Õ´Õ¸Ö‚Õ¿ (Income)")
    plt.plot(x, debt, marker="o", label="ÕŠÕ¡Ö€Õ¿Ö„ (Debt)")
    plt.plot(x, savings, marker="o", label="Ô½Õ¶Õ¡ÕµÕ¸Õ²Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶ (Savings)")
    plt.legend()
    plt.grid(True)
    plt.tight_layout()
    plt.savefig(chart_path)
    plt.close()

# ---------- Summary ----------
def calc_summary(data):
    first, last = data[0], data[-1]

    def pct(from_, to_):
        try:
            if from_ == 0:
                return 0.0
            return (to_ - from_) * 100.0 / from_
        except Exception:
            return 0.0

    inc_g = pct(first.get("income", 0), last.get("income", 0))
    deb_r = (
        pct(first.get("debt", 0), last.get("debt", 0)) * -1
    )  # debt reduction positive
    sav_g = pct(first.get("savings", 0), last.get("savings", 0))

    return {
        "latest_income": last.get("income", 0),
        "latest_debt": last.get("debt", 0),
        "latest_savings": last.get("savings", 0),
        "income_growth_pct": round(inc_g, 1),
        "debt_reduction_pct": round(deb_r, 1),
        "savings_growth_pct": round(sav_g, 1),
    }

def calc_goal_block(data, goal_amount, goal_date_str):

    last = data[-1] if data else {}
    cur = int(last.get("savings", 0) or 0)
    goal_dt = date.fromisoformat(goal_date_str)
    today = date.today()
    days_left = max((goal_dt - today).days, 0)
    remaining = max(goal_amount - cur, 0)
    pct = 0 if goal_amount <= 0 else min(100.0, round(cur * 100.0 / goal_amount, 1))
    need_per_day = round(remaining / max(days_left, 1), 2)
    return {
        "goal_amount": goal_amount,
        "goal_date": goal_dt.isoformat(),
        "current_savings": cur,
        "progress_pct": pct,
        "remaining": remaining,
        "days_left": days_left,
        "need_per_day": need_per_day,
    }

# ---------- PDF ----------
def build_pdf(summary, chart_path: Path, pdf_path: Path):
    styles = getSampleStyleSheet()
    story = []

    title = Paragraph("ðŸ“Š Õ–Õ«Õ¶Õ¡Õ¶Õ½Õ¡Õ¯Õ¡Õ¶ Õ€Õ¡Õ·Õ¾Õ¥Õ¿Õ¾Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶", styles["Title"])
    datep = Paragraph(
        f"ÕÕ¿Õ¥Õ²Õ®Õ¾Õ¡Õ® Õ§Õ {datetime.now().strftime('%Y-%m-%d %H:%M')}", styles["Normal"]
    )

    story += [title, Spacer(1, 8), datep, Spacer(1, 16)]
    story += [Image(str(chart_path), width=500, height=260), Spacer(1, 18)]

    table_data = [
        ["Õ‘Õ¸Ö‚ÖÕ«Õ¹", "Ô±Ö€ÕªÕ¥Ö„"],
        ["ÕŽÕ¥Ö€Õ»Õ«Õ¶ ÔµÕ¯Õ¡Õ´Õ¸Ö‚Õ¿", f"{summary['latest_income']:,} Õ¤Ö€Õ¡Õ´".replace(",", " ")],
        ["ÕŽÕ¥Ö€Õ»Õ«Õ¶ ÕŠÕ¡Ö€Õ¿Ö„", f"{summary['latest_debt']:,} Õ¤Ö€Õ¡Õ´".replace(",", " ")],
        [
            "ÕŽÕ¥Ö€Õ»Õ«Õ¶ Ô½Õ¶Õ¡ÕµÕ¸Õ²Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶",
            f"{summary['latest_savings']:,} Õ¤Ö€Õ¡Õ´".replace(",", " "),
        ],
        ["ÔµÕ¯Õ¡Õ´Õ¸Ö‚Õ¿Õ« Õ¡Õ³ %", f"{summary['income_growth_pct']}%"],
        ["ÕŠÕ¡Ö€Õ¿Ö„Õ« Õ¶Õ¾Õ¡Õ¦Õ¸Ö‚Õ´ %", f"{summary['debt_reduction_pct']}%"],
        ["Ô½Õ¶Õ¡ÕµÕ¸Õ²Õ¸Ö‚Õ©ÕµÕ¡Õ¶ Õ¡Õ³ %", f"{summary['savings_growth_pct']}%"],
    ]

    t = Table(table_data, hAlign="LEFT", colWidths=[220, 220])
    t.setStyle(
        TableStyle(
            [
                ("GRID", (0, 0), (-1, -1), 0.5, colors.grey),
                ("BACKGROUND", (0, 0), (-1, 0), colors.lightgrey),
                ("FONTNAME", (0, 0), (-1, 0), "Helvetica-Bold"),
                ("BOTTOMPADDING", (0, 0), (-1, 0), 8),
            ]
        )
    )
    story += [t, Spacer(1, 12)]

    footer = Paragraph("ÕÕ¿Õ¥Õ²Õ®Õ¾Õ¥Õ¬ Õ§ ProPlus Õ°Õ¡Õ´Õ¡Õ¯Õ¡Ö€Õ£Õ« Õ´Õ«Õ»Õ¸ÖÕ¸Õ¾", styles["Italic"])
    story += [footer]

    doc = SimpleDocTemplate(str(pdf_path), pagesize=A4)
    doc.build(story)

import os

GOAL_DATE = os.getenv("GOAL_DATE", "2025-09-26")

# ---------- Main ----------
def main():
    # 1) ÕÕ¾ÕµÕ¡Õ¬Õ¶Õ¥Ö€ Ö„Õ¡Õ·Õ¥Õ¬ DB-Õ«Ö (Ö„Õ¸ Õ£Õ¸ÕµÕ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶ Õ¸Ö‚Õ¶Õ¥ÖÕ¸Õ² Ö†Õ¸Ö‚Õ¶Õ¯ÖÕ«Õ¡Õ¶)
    data = fetch_data()
    if not data:
        print("â„¹ï¸ ÕÕ¾ÕµÕ¡Õ¬Õ¶Õ¥Ö€ Õ¹Õ¯Õ¡Õ¶Õ report Õ¹Õ« Õ½Õ¿Õ¥Õ²Õ®Õ¾Õ«.")
        return

    # 2) ÕƒÕ¡Õ¶Õ¡ÕºÕ¡Ö€Õ°Õ¶Õ¥Ö€
    chart_path = REPORTS_DIR / "finance_report.png"
    pdf_path = REPORTS_DIR / "finance_report.pdf"

    # 3) Ô³Ö€Õ¡Ö†Õ«Õ¯
    create_chart(data, chart_path)

    # 4) Ô±Õ´ÖƒÕ¸ÖƒÕ¸Ö‚Õ´ + Õ†ÕºÕ¡Õ¿Õ¡Õ¯Õ« Õ¢Õ¬Õ¸Õ¯
    summary = calc_summary(data)
    goal_block = calc_goal_block(data, GOAL_AMOUNT, GOAL_DATE)

    # 5) PDF
    build_pdf(summary, chart_path, pdf_path, goal_block)

    print(f"âœ… PNG: {chart_path}")
    print(f"âœ… PDF: {pdf_path}")

def progress_bar(flowables, pct: float, width_mm=160, height_mm=8):
    # Õ¡ÕµÕ½ flowable-Õ¨ Õ¯Õ½Õ¿Õ¥Õ²Õ®Õ¥Õ¶Ö„ ÕºÕ¡Õ¿Õ¯Õ¥Ö€Õ«ÖÕ ReportLab-Õ« canvas-Õ¸Õ¾

    tmp_png = REPORTS_DIR / "goal_bar.png"

    bar_w = width_mm * mm
    bar_h = height_mm * mm
    fill_w = bar_w * (pct / 100.0)

    c = canvas.Canvas(str(tmp_png), pagesize=(bar_w, bar_h))
    # Ö†Õ¸Õ¶
    c.setFillColor(HexColor("#e6e6e6"))
    c.rect(0, 0, bar_w, bar_h, fill=1, stroke=0)
    # Õ¬ÖÕ¾Õ¡Õ® Õ°Õ¡Õ¿Õ¾Õ¡Õ®
    c.setFillColor(HexColor("#4caf50"))  # Õ¯Õ¡Õ¶Õ¡Õ¹
    c.rect(0, 0, fill_w, bar_h, fill=1, stroke=0)
    c.save()

    flowables += [Image(str(tmp_png), width=bar_w, height=bar_h), Spacer(1, 6)]
